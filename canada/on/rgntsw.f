      SUBROUTINE RGNTSW(LESTB,ITRNIN)
      IMPLICIT NONE
C----------
C CANADA-ON $Id$
C----------
C
C  THIS SUBROUTINE PREDICTS DIAMETER AND HT GROWTH FOR SOFTWOODS THAT
C  HAVE A DIAMETER OF 1.0 INCH OR LESS.  DESPITE THE NAME, THIS
C  ROUTINE COMPUTES BOTH SOFTWOOD AND HARDWOOD GROWTH.
C
C  **REGENT** COMPUTES HEIGHT AND DIAMETER INCREMENTS FOR SMALL
C  TREES.  THE HEIGHT INCREMENT MODEL AND DBH INCREMENT MODEL ARE
C  APPLIED TO TREES THAT ARE LESS THAN 1.0 INCH DIAMETER.  FOR TREES
C  THAT ARE GREATER THAN 0.5 INCH DBH, HEIGHT INCREMENT PRDICTIONS
C  ARE AVERAGED WITH THE PREDICTIONS FROM THE LARGE TREE MODEL.
C  HEIGHT INCREMENT IS A FUNCTION OF HABITAT TYPE, SLOPE, ASPECT, TREE
C  HEIGHT, BASAL AREA IN LARGER TREES, AND STAND CROWN COMPETITION
C  FACTOR.  DIAMETER IS ASSIGNED FROM A HEIGHT DIAMETER FUNCTION WITH
C  ADJUSTMENTS FOR RELATIVE SIZE AND STAND DENSITY.  INCREMENT IS
C  COMPUTED BY SUBTRACTION.  **REGENT** IS CALLES FROM **CRATET** DURING
C  CALIBRATION AND FROM **GRINCR* DURING CYCLING.  ENTRY **REGCON**
C  IS CALLED FROM **RCON** TO LOAD MODEL PARAMETERS THAT NEED ONLY BE
C  RESOLVED ONCE.
C
C  **REGENT** IS ALSO USED TO PREDICT HEIGHT INCREMENT, DBH AND CROWN
C  RATIO FOR TREES THAT ARE CREATED BY THE REGENERATION ESTABLISHMENT
C  MODEL.  5-YEAR OLD TREES ARE GENERATED BY **ESTAB** AND **REGENT**
C  COMPUTES INCREMENTS FROM AGE 5 TO THE END OF THE CYCLE.

COMMONS
C
      INCLUDE 'PRGPRM.F77'
      INCLUDE 'CALCOM.F77'
      INCLUDE 'ARRAYS.F77'
      INCLUDE 'COEFFS.F77'
      INCLUDE 'CONTRL.F77'
      INCLUDE 'OUTCOM.F77'
      INCLUDE 'PLOT.F77'
      INCLUDE 'HTCAL.F77'
      INCLUDE 'MULTCM.F77'
      INCLUDE 'ESTCOR.F77'
      INCLUDE 'VARCOM.F77'
      INCLUDE 'METRIC.F77'

COMMONS

C  DIMENSIONS FOR INTERNAL VARIABLES:
C
C   BANEXT -- ESTIMATED STAND BASAL AREA AT START OF EACH HEIGHT INCREMENT
C             PREDICTION SUBCYCLE.
C   CORTEM -- A TEMPORARY ARRAY FOR PRINTING CORRECTION TERMS.
C     KPER -- NUMBER OF YEARS (MAX OF 5) IN EACH HEIGHT INCREMENT PREDICTION
C             SUBCYCLE.
C   NUMCAL -- A TEMPORARY ARRAY FOR PRINTING NUMBER OF HEIGHT
C             INCREMENT OBSERVATIONS BY SPECIES.
C   RDNEXT -- RELATIVE DENSITY (CCF) AT START OF EACH HEIGHT INCREMENT
C             PREDICTION SUBCYCLE.
C    RHCON -- CONSTANT FOR THE HEIGHT INCREMENT MODEL.  INCLUDES EFFECTS
C             OF SPECIES, LOCATION, SLOPE, AND ASPECT AS LOADED IN
C             RCON.
C     XMAX -- UPPER END OF THE RANGE OF DIAMETERS OVER WHICH HEIGHT
C             INCREMENT PREDICTIONS FROM SMALL AND LARGE TREE MODELS
C             ARE AVERAGED.
C     XMIN -- LOWER END OF THE RANGE OF DIAMETERS OVER WHICH HEIGHT
C             INCREMENT PREDICTIONS FROM THE SMALL AND LARGE TREE
C             ARE AVERAGED.

C     NUMBER OF SMALL TREE HEIGHT GROWTH EQUATIONS

      LOGICAL  DEBUG,LESTB,LSKIPH
      INTEGER  ITRNIN
	INTEGER  I,J,K,L,IYR,NTYR,NPER,ITOT,N
	INTEGER  IS,NYR,KY,ISPC,I1,I2,I3,IREFI
	INTEGER  KPER(10)
      REAL     REGYR,HSIGMA,BACON,BAJ,RDJ,CON
      REAL     SCALE,D1,D2,P,B1,B2,C1,C2,CW,BI,CI
	REAL     PN,BAYR,CCFYR,BARK,SIM
	REAL     XMX,XMN,H1,BAL,BALM
	REAL     H,HK,D,HM,LHM,H2,DGJ
	REAL     ZZRAN,HTGR,XWT,NEWDBH,HTG2
	REAL     XRDGRO,XRHGRO,DK,DDS,DGK,HTGR1
      REAL     XMAX(MAXSP),XMIN(MAXSP),DIAM(MAXSP)
	REAL     BANEXT(10),RDNEXT(10)
	REAL     CORNEW,CORTEM(MAXSP),NUMCAL(MAXSP)
	REAL     SNP,SNX,SNY,SCALE3,SI,SHI,SLO,RELSI,RSIMOD
	REAL     BHAB,BLH

      REAL     BACHLO,BRATIO
      EXTERNAL RANN

C  DATA STATEMENTS.

      DATA DIAM/2*0.3,0.2,11*0.3,54*0.2,4*0.3/
      DATA XMIN / MAXSP*3.15 /, XMAX/ MAXSP*4.72 / 

      DATA REGYR  /1.0/     ! Standard regen period is 5 yrs
      DATA HSIGMA /0.3819/  ! root of the average MSE (klunky)
      DATA BACON  /0.005454154/


C  CHECK FOR DEBUG.

      CALL DBCHK (DEBUG,'RGNTSW',6,ICYC)
      IF(DEBUG) WRITE(JOSTND,9980)ICYC
 9980 FORMAT(' ENTERING SUBROUTINE RGNTSW CYCLE =',I5)

C----------
C  IF THIS IS THE FIRST CALL TO REGENT, BRANCH TO STATEMENT 40 FOR
C  MODEL CALIBRATION.
C----------
      IF(LSTART) GOTO 40
      CALL MULTS (3,IY(ICYC),XRHMLT)
      CALL MULTS(6,IY(ICYC),XRDMLT)
      IF (ITRN.LE.0) GO TO 91

C  THE SMALL TREE HEIGHT INCREMENT MODEL IS BASED ON 5-YEAR INCREMENT DATA.
C  TO AVOID BIAS, PREDICTIONS ARE MADE FOR SUBCYCLES THAT ARE LESS THAN OR
C  EQUAL TO 5 YEARS IN LENGTH.  THE FOLLOWING CODE DETERMINES THE NUMBER
C  AND LENGTH OF SUBCYCLES FROM CYCLE LENGTH.

      LSKIPH=.FALSE.
      DO I = 1,10
        KPER(I)=0
        BANEXT(I)=0.0
        RDNEXT(I)=0.0
      ENDDO

      NTYR=FINT
      IF(LSTART) NTYR=IFINTH
      IF(LESTB) NTYR=NTYR-5
      IF(LESTB.AND.NTYR.LE.0) LSKIPH=.TRUE.
      IYR=REGYR
      NPER=NTYR/IYR
      IF(MOD(NTYR,IYR).NE.0) NPER=NPER+1
      ITOT=NTYR
      N=NPER
      DO I=1,NPER
        IF(N.EQ.1) GOTO 3
        KPER(I)=ITOT/N
        ITOT=ITOT-KPER(I)
        N=N-1
      ENDDO
    3 IF(NPER.GT.0) KPER(NPER)=ITOT

      SCALE=YR/FINT
      IF(DEBUG) WRITE(JOSTND,8996) LESTB,LSKIPH,ITRN,ITRNIN,SCALE
 8996 FORMAT(' IN RGNTSW, LESTB = ',L1,', LSKIPH = ',L1,
     &  ', ITRN = ',I4,', ITRNIN = ',I4,', SCALE = ',F6.3)

C     ESTIMATE THE CONTRIBUTION TO STAND BASAL AREA AND CCF FOR LARGE TREES AT
C     THE START OF EACH PROJECTION SUBCYCLE.  IF CALLED FROM **ESTAB**, BRANCH
C     TO STATEMENT 9 AND INTERPOLATE FROM OLD AND NEW DENSITY VALUES.
C     OTHERWISE, 10-YEAR CHANGE IS COMPUTED FROM PREDICTED DBH INCREMENT AND
C     ANNUALIZED.  THEN, ANNUAL RATE IS MULTIPLIED BY SUBCYCLE LENGTH TO
C     DETERMINE CONTRIBUTION FOR EACH SUBCYCLE.  A ONE PERCENT ANNUAL RATE
C     OF MORTALITY IS ASSUMED.  CONTRIBUTIONS OF SMALL TREES ARE COMPUTED AS
C     INCREMENT PREDICTIONS ARE MADE FOR PRECEDING SUBCYCLE.

      IF(LESTB) GOTO 9
      DO J=1,NPER
        BANEXT(J)=BA
        RDNEXT(J)=RELDEN
      ENDDO
      IF(NPER.EQ.1) GOTO 12
      DO I=1,ITRN
        D1=DBH(I)
        IF(D1.LT.3.0) GOTO 6
        IS=ISP(I)
        P=PROB(I)
        D2=D1+DG(I)/BKRAT(ISP(I))
        B1=BACON*D1*D1
        B2=BACON*D2*D2
        CALL CCFCAL(IS,D1,HT(I),ICR(I),P,.FALSE.,C1,CW,1)
        CALL CCFCAL(IS,D2,HT(I),ICR(I),P,.FALSE.,C2,CW,1)
        BI=(B2-B1)/10.0
        CI=(C2-C1)/10.0
        K=0
        DO J=2,NPER
          K=K+KPER(J-1)
          PN=P*0.99**K
          RDNEXT(J)=RDNEXT(J)+K*CI
          BANEXT(J)=BANEXT(J)+K*BI*PN
        ENDDO
    6 ENDDO
      GOTO 12

C     IF CALLED FROM **ESTAB**, DIAMETERS AND DENSITY STATISTICS HAVE
C     BEEN UPDATED AND DENSITIES CORRESPONDING TO BEGINNINGS OF SUBCYCLES
C     CAN BE INTERPOLATED FROM DIFFERENCE BETWEEN OLD AND NEW STATS.  THE
C     TREES ARE SENT TO REGENT WITH A HEIGHT CORRESPONDING TO 5 YEARS AFTER
C     THE START OF THE CYCLE.

    9 CONTINUE
      BAYR=0.0
      CCFYR=0.0
      IF(LSKIPH) GOTO 10
      BAYR=(BA-ATBA)/ITOT
      CCFYR=(RELDEN-ATCCF)/ITOT
   10 CONTINUE
      NYR=5
      DO J=1,NPER
        RDNEXT(J)=ATCCF+NYR*CCFYR
        BANEXT(J)=ATBA+NYR*BAYR
        NYR=NYR+KPER(J)
      ENDDO
   12 CONTINUE

C     STORE INITIAL HEIGHTS IN WK3

      DO I=1,ITRN
        WK3(I)=HT(I)
      ENDDO

C     ENTER LOOP FOR NEXT SUBCYCLE.

      KY = 0
      DO J=1,NPER  !17 LOOP

        KY=KY+KPER(J)
        BAJ=BANEXT(J)
        RDJ=RDNEXT(J)

C     PROCESS ALL TREES WITHIN THIS SUBCYCLE IN SPECIES ORDER.  LOAD
C     SPECIES DEPENDENT CONSTANTS.

        DO ISPC=1,MAXSP  ! 16 LOOP

          I1=ISCT(ISPC,1)
          IF(I1.EQ.0) GOTO 16
          I2=ISCT(ISPC,2)

          XRHGRO=XRHMLT(ISPC)
          XRDGRO=XRDMLT(ISPC)
          CON=RHCON(ISPC)+HCOR(ISPC)
          XMX=XMAX(ISPC)
          XMN=XMIN(ISPC)

	    SIM = SITEAR(ISPC) * FTtoM

C     PROCESS NEXT TREE RECORD.  STORE INTERMEDIATE HEIGHTS IN WK3.

          DO I3=I1,I2

C     BYPASS INCREMENT CALCULATION IF DBH IS GREATER THAN XMX OR IF
C     CALL IS FROM **ESTAB** AND TREE SUBSCRIPT IS LESS THAN ITRNIN.

            I=IND1(I3)
            D=DBH(I)
            IF(D.GE.XMX) GOTO 15
            IF(LESTB .AND. I.LT.ITRNIN) GOTO 15
            P=PROB(I)
            H1=WK3(I)
            BAL=BAJ*(100.0-PCT(I))*0.01
            CALL CCFCAL(ISPC,D,H1,ICR(I),P,.FALSE.,C1,CW,1)
            B1=BACON*D*D

            ! Penner 2010 annual prediction of height growth (ft/yr)
            CALL ONSTHG(HTG2, ISPC, D, H1, SITEAR(ISPC), BAL)

            HTG2 = LOG(HTG2 * REGYR)
            H2 = H1 + EXP(HTG2)*(FLOAT(KPER(J))/REGYR)*XRHGRO
            WK3(I)=H2

C     UPDATE DENSITY FOR NEXT SUBCYCLE.  IF ONLY ONE SUBCYCLE OR
C     IF INITIAL DBH IS GREATER THAN 3 INCHES, BYPASS DENSITY UPDATE.
C     DIAMETER IS ADJUSTED FOR DENSITY AND USER-SUPPLIED MULTIPLIER.
C     INCREMENT IS DETERMINED FROM THE DIFFERENCE BETWEEN COMPUTED
C     DIAMETERS AND IS BOUNDED TO BE GREATER THAN OR EQUAL TO ZERO.

            D2=D
            IF(J.EQ.NPER.OR.D.GE.3.0) GOTO 15
            IF(H2.LE.4.5) GOTO 15

            D1=DIAM(ISPC)
            IF(H1.GT.4.5) THEN
	        CALL ONHTDBH(ISPC,D1,BAJ,H1,RMSQD,NEWDBH)
	        D1 = NEWDBH
            ENDIF
	      CALL ONHTDBH(ISPC,D2,BAJ,H2,RMSQD,NEWDBH)
	      D2 = NEWDBH
            DGJ=(D2-D1)*XRDGRO
            D2=D+DGJ

C     COMPUTE ADJUSTMENT TO STAND BASAL AREA AND CCF FOR NEXT SUBCYCLE.
C     ASSUME A 1.5 PERCENT ANNUAL MORTALITY RATE.

            CALL CCFCAL(ISPC,D2,H2,ICR(I),P,.FALSE.,C2,CW,1)
            RDNEXT(J+1)=RDNEXT(J+1)+(C2-C1)*0.985**KY
            BANEXT(J+1)=BANEXT(J+1)+(BACON*D2*D2-B1)*P*0.985**KY

   15     ENDDO

C     END OF SPECIES LOOP WITHIN SUBCYCLE

   16   ENDDO

C     END OF SUBCYCLE LOOP.  END OF PERIOD HEIGHT IS STORED IN WK3.

      ENDDO

C     AFTER LAST SUBCYCLE, COMPUTE ACTUAL HEIGHT INCREMENT FOR FULL CYCLE BY
C     SUBTRACTION; CONVERT BACK TO LOG SCALE TO ADD IN RANDOM ERROR.

      DO ISPC=1,MAXSP

        I1=ISCT(ISPC,1)
        IF(I1.EQ.0) GOTO 30
        I2=ISCT(ISPC,2)

        XRDGRO=XRDMLT(ISPC)
        XMX=XMAX(ISPC)
        XMN=XMIN(ISPC)

        DO I3=I1,I2
          I=IND1(I3)
          D=DBH(I)
          IF(D.GE.XMX) GOTO 25
          IF(LESTB .AND. I.LT.ITRNIN) GOTO 25
          K=I
          L=0
          H=HT(I)
          HK=WK3(I)

C     IF CALLED FROM **ESTAB** AND TOTAL CYCLE LENGTH IS LESS THAN OR EQUAL
C     TO 5 YEARS, SKIP HEIGHT INCREMENT CALCULATION BUT ASSIGN CR AND DBH.

          IF(LSKIPH) THEN
            HTG(K)=0
            GOTO 20
          ENDIF
          HTGR1=HK-H
          IF (HTGR1.LT.0.0) HTGR1=0.0

C     DRAW RANDOM INCREMENT GIVEN EXPECTED VALUE, HTGR, AND STD. DEV.,
C     HSIGMA.  BOUND DRAW TO (-1.5*SD < ZZRAN < 1.0*SD); IF TRIPLING,
C     EACH TRIPLE GETS A NEW RANDOM NUMBER.  DO NOT TRIPLE IF CALLING
C     FROM **ESTAB**.  DO NOT APPLY HEIGHT GROWTH MULTIPLIER; MULTIPLIER
C     WAS USED DURING SUBCYCLING.

   18     ZZRAN=0.0
          IF (DGSD.GE.1.0) ZZRAN = BACHLO(0.0,1.0,RANN)
          IF((ZZRAN .GT. 1.0) .OR. (ZZRAN .LT. -1.5)) GOTO 18
          HTGR = HTGR1*EXP(ZZRAN*HSIGMA)

C     COMPUTE WEIGHTS FOR THE LARGE AND SMALL TREE HEIGHT INCREMENT
C     ESTIMATES.  IF DBH IS LESS THAN OR EQUAL TO XMN OR IF CALLED
C     FROM **ESTAB**, THE LARGE TREE PREDICTION IS IGNORED (XWT=0.0).

          XWT=0.0
          IF(D.LE.XMN.OR.LESTB) GOTO 19
          XWT=(D-XMN)/(XMX-XMN)
   19     HTG(K)=HTGR*(1.0-XWT) + XWT*HTG(K)
C
C     CHECK FOR SIZE CAP COMPLIANCE.
C
          IF((H+HTG(K)).GT.SIZCAP(ISPC,4))THEN
            HTG(K)=SIZCAP(ISPC,4)-H
            IF(HTG(K) .LT. 0.1) HTG(K)=0.1
          ENDIF

C     ASSIGN DBH AND COMPUTE DBH INCREMENT FOR TREES WITH DBH LESS
C     THAN 3 INCHES.  COMPUTE 10-YEAR DBH INCREMENT REGARDLESS OF
C     PROJECTION PERIOD LENGTH.  BYPASS INCREMENT CALCULATION IF
C     D GE 1.0 INCHES.

   20     IF(D.GE.1.0) GOTO 23

          D1 = DIAM(ISPC)
          IF (H.GT.4.5)
     >      CALL ONHTDBH(ISPC,D,BAJ,H,RMSQD,D1)

	    HK = H + HTG(K)
          IF (HK.LE.4.5) THEN
            DBH(K) = D + HK*0.001
	      DGK = 0.0
	      DG(K) = 0.0
	    ELSE
	      DK = 0.
            CALL ONHTDBH(ISPC,D,BAJ,HK,RMSQD,DK)
            IF(DK.LT.DIAM(ISPC)) DK = DIAM(ISPC)
            DK = DK + HK*0.001

C     IF CALLING FROM **ESTAB** ASSIGN DIAMETER AND DIAMETER
C     INCREMENT.

            IF (LESTB) THEN
              DBH(K)=DK
              DG(K)=DK
            ELSE

C     DIAMETER INCREMENT IS THE DIFFERENCE BETWEEN COMPUTED
C     DIAMETERS.  MULTIPLIER IS APPLIED TO DIAMETER INCREMENT
C     AT THIS POINT.

              DGK=(DK-D1)*XRDGRO
              IF(DGK.LT.0.0) DGK=0.0

C     SCALE DIAMETER INCREMENT FOR BARK AND PERIOD LENGTH.
C     ADJUSTMENT IN ORDER TO MAINTAIN CONSISTENCY WITH **GRADD**,
C     ADJUSTMENTS ARE MADE ON THE DDS SCALE.

              BARK=BRATIO(ISPC,DBH(K),H)
              DG(K)=DGK*BARK
              DDS = DG(K)*(2.0*BARK*DK+DG(K))*SCALE
              DG(K)=SQRT((DK*BARK)**2.0+DDS)-BARK*DK
            ENDIF
            IF((DBH(K)+DG(K)).LT.DIAM(ISPC))THEN
              DG(K)=DIAM(ISPC)-DBH(K)
            ENDIF
          ENDIF

C     CHECK FOR TREE SIZE CAP COMPLIANCE

          CALL DGBND(ISPC,DBH(K),DG(K))

C     PRINT DEBUG AND RETURN TO PROCESS NEXT TRIPLE OR NEXT TREE.

   23     IF(.NOT.DEBUG) GOTO 24
          WRITE(JOSTND,9000) I,K,ISPC,H,HTG(K),HK,DBH(K),DG(K),BARK
 9000     FORMAT(' IN RGNTSW LOOP 2, I=',I4,', K=',I4,', ISPC=',I3,
     &      ', CUR HT=',F7.2,', HT INC=',F7.4/T20,'NEW HT=',F7.2,
     &      ', CUR DBH=',F7.2,', 10-YR DBH INC=',F7.4,' ,BARK=',F5.4)
   24     CONTINUE

          IF(LESTB .OR. .NOT.LTRIP .OR. L.GE.2) GOTO 25
          L=L+1
          K=ITRN+2*I-2+L
          GOTO 18

C     END OF GROWTH PREDICTION LOOP.  PRINT DEBUG INFO IF DESIRED.

   25   ENDDO
   30 ENDDO
   40 CONTINUE
C
C     THIS IS A SECTION THAT NEEDS TO BE REVISED TO IMPLEMENT SMALL TREE
C     SELF-CALIBRATION, WHICH IS NOT YET ACTIVE (20-Mar-2007)
C
cC----------
cC  SMALL TREE HEIGHT CALIBRATION SECTION.
cC----------
c      DO 45 ISPC=1,MAXSP
c      HCOR(ISPC)=0.0
c      CORTEM(ISPC)=1.0
c      NUMCAL(ISPC)=0
c   45 CONTINUE
c      IF (ITRN.LE.0) GO TO 91
c      IF(IFINTH .EQ. 0)  GOTO 95
cC----------
cC  DETERMINE BASAL AREA IN LARGE TREES AT START OF EACH
cC  PREDICTION SUBCYCLE.
cC----------
c      DO 46 J=1,NPER
c      BANEXT(J)=ATBA
c      RDNEXT(J)=ATCCF
c   46 CONTINUE
c      IF(NPER.EQ.1) GO TO 50
cC----------
cC  IF THERE IS MORE THAN 1 SUBCYCLE FOR HEIGHT INCREMENT PREDICTION,
cC  (IFINTH > 5) ESTIMATE VALUES OF BA AND RELATIVE DENSITY (CCF) AT
cC  START OF EACH SUBCYCLE.  10-YEAR CHANGE IS COMPUTED FROM BACKDATED
cC  DIAMETER (WK3) AND 10-YEAR DIAMETER INCREMENT COMPUTED DURING CALIBRATION.
cC  LINEAR INTERPOLATION IS USED TO ASSIGN VALUES FOR SUBCYCLES.
cC----------
c      DO 49 I=1,ITRN
c      D1=WK3(I)
c      IS=ISP(I)
c      P=PROB(I)
c      D2=WK3(I)+DG(I)/BRATIO(IS,D1,HT(I))
c      B1=BACON*D1*D1
c      B2=BACON*D2*D2
c      CALL CCFCAL(IS,D1,HT(I),ICR(I),P,.FALSE.,C1,CW,1)
c      CALL CCFCAL(IS,D2,HT(I),ICR(I),P,.FALSE.,C2,CW,1)
c      BI=(B2-B1)/10.0
c      CI=(C2-C1)/10.0
c      K=0
c      DO 48 J=2,NPER
c      K=K+KPER(J-1)
c      PN=P*0.99**K
c      RDNEXT(J)=RDNEXT(J)+K*CI*PN
c      BANEXT(J)=BANEXT(J)+K*BI*PN
c   48 CONTINUE
c   49 CONTINUE
c   50 CONTINUE
c      DO 100 ISPC=1,MAXSP
cC----------
cC  BEGIN PROCESSING TREE LIST IN SPECIES ORDER.  DO NOT CALCULATE
cC  CORRECTION TERMS IF THERE ARE NO TREES FOR THIS SPECIES.
cC----------
c      CORNEW=1.0
c      I1=ISCT(ISPC,1)
c      IF(I1.EQ.0 .OR. .NOT. LHTCAL(ISPC)) GO TO 100
c      I2=ISCT(ISPC,2)
c      N=0
c      SNP=0.0
c      SNX=0.0
c      SNY=0.0
c      IREFI=IREF(ISPC)
cC----------
cC  COMPUTE RELATIVE SITE INDEX MODIFIER  AND SET SCALE FOR HARDWOODS.
cC----------
c      IF(ISPC .GE. 15) THEN
c        SCALE3 = 10.0 / FINTH
c        SI=SITEAR(ISPC)
c        IF(SI .GT. SHI) SI=SHI
c        IF(SI .LE. SLO) SI=SLO + 0.5
c        RELSI=(SI-SLO)/(SHI-SLO)
c        RSIMOD = .5*(RELSI)+.5
c        IF(DEBUG) WRITE(JOSTND,9988)SI,RELSI,ISPC,RSIMOD
c 9988   FORMAT(' IN RGNTHW SI,RELSI,ISPC,RSIMOD = ',
c     &  F7.2,F10.3,I6,F10.3)
c      ENDIF
cC----------
cC  SET SPECIES CONSTANTS AND SCALE FOR SOFTWOODS.
cC----------
c      IF(ISPC .LE. 14) THEN
c        SCALE3 = 5.0 / FINTH
c      ENDIF
cC----------
cC  BEGIN TREE LOOP WITHIN SPECIES.  IF MEASURED HEIGHT INCREMENT IS
cC  LESS THAN OR EQUAL TO ZERO, OR DBH IS LESS THAN 5.0, THE RECORD
cC  WILL BE EXCLUDED FROM THE CALIBRATION.
cC----------
c      DO 60 I3=I1,I2
c      I=IND1(I3)
c      H=HT(I)
cC----------
cC  DIA GT 3 INCHES INCLUDED IN OVERALL MEAN
cC----------
c      IF(IHTG.LT.2) H=H-HTG(I)
c      IF(DBH(I).GE.3.0.OR.H.LT.0.01) GO TO 60
c      IF(ISPC .LE. 14) THEN
c        HK=H
c        DO 55 J=1,NPER
c        BAJ=BANEXT(J)
c        RDJ=RDNEXT(J)
c        BAL=BAJ*(100.0-PCT(I))*0.0001
c        EDH=EXP(BHAB + BLH*ALOG(HK) + BCCF*RDJ + BBAL*BAL)
c        HK=HK+EDH
c   55   CONTINUE
c        EDH=HK-H
c      ELSE
c        AG1 = (H*12*2.54/26.9825)**.8509
c        AG2 = AG1 + 10.
c        H2 = (26.9825*AG2**1.1752)/(2.54*12.0)
c        EDH =(H2-H)*RSIMOD*RHCON(ISPC)
cC----------
cC  GROWTH RATES APPEAR HIGH, REDUCE BY 25%. DIXON 8-27-92
cC----------
c        EDH=EDH*.75
cC----------
cC  GET MODIFIER BORROWED FROM THE DIAMETER GROWTH EQUATIONS AND
cC  ADJUST THE HEIGHT GROWTH ESTIMATE.
cC----------
c        CALL BALMOD(ISPC,D,BA,RMSQD,GM,DEBUG)
c        EDH=EDH*GM
c        IF(DEBUG)WRITE(JOSTND,*)' I,GM,EDH= ',I,GM,EDH
cC
c        IF(EDH .LT. 0.0) EDH=0.0
c        IF(DEBUG) WRITE(JOSTND,*)' AG1,AG2,H,H2,EDH,D=',
c     &  AG1,AG2,H,H2,EDH,DBH(I)
c      ENDIF
c      P=PROB(I)
c      IF(HTG(I).LT.0.001)GOTO 60
c      TERM=HTG(I) * SCALE3
c      SNP=SNP+P
c      SNX=SNX+EDH*P
c      SNY=SNY+TERM*P
c      N=N+1
cC----------
cC  PRINT DEBUG INFO IF DESIRED.
cC----------
c       IF(DEBUG)WRITE(JOSTND,9991) NPLT,I,ISPC,H,DBH(I),ICR(I),
c     & PCT(I),ATCCF,RHCON(ISPC),EDH,TERM
c 9991 FORMAT(' NPLT=',A26,',  I=',I5,',  ISPC=',I3,',  H=',F6.1,
c     & ',  DBH=',F5.1,',  ICR',I5,',  PCT=',F6.1,',  RELDEN=',
c     & F6.1 / 13X,'RHCON=',F10.3,',  EDH=',F10.3,', TERM=',F10.3)
cC----------
cC  END OF TREE LOOP WITHIN SPECIES.
cC----------
c   60 CONTINUE
c      IF(DEBUG) WRITE(JOSTND,9992) ISPC,SNP,SNX,SNY
c 9992 FORMAT(/' SUMS FOR SPECIES ',I2,':  SNP=',F10.2,
c     & ';  SNX=',F10.2,';  SNY=',F10.2)
cC----------
cC  COMPUTE CALIBRATION TERMS.  CALIBRATION TERMS ARE NOT COMPUTED
cC  IF THERE WERE FEWER THAN NCALHT (DEFAULT=5) HEIGHT INCREMENT
cC  OBSERVATIONS FOR A SPECIES.
cC----------
c      IF(N.LT.NCALHT) GO TO 80
cC----------
cC  CALCULATE MEANS FOR THE POPULATION AND FOR THE SAMPLE ON THE
cC  NATURAL SCALE.
cC----------
c      SNX=SNX/SNP
c      SNY=SNY/SNP
cC----------
cC  CALCULATE RATIO ESTIMATOR.
cC----------
c      CORNEW = SNY/SNX
c      IF(CORNEW.LE.0.0) CORNEW=1.0E-4
c      HCOR(ISPC)=ALOG(CORNEW)
cC----------
cC  TRAP CALIBRATION VALUES OUTSIDE 2.5 STANDARD DEVIATIONS FROM THE 
cC  MEAN. IF C IS THE CALIBRATION TERM, WITH A DEFAULT OF 1.0, THEN
cC  LN(C) HAS A MEAN OF 0.  -2.5 < LN(C) < 2.5 IMPLIES 
cC  0.0821 < C < 12.1825
cC----------
c      IF(CORNEW.LT.0.0821 .OR. CORNEW.GT.12.1825) THEN
c        CALL ERRGRO(.TRUE.,27)
c        WRITE(JOSTND,9194)ISPC,JSP(ISPC),CORNEW
c 9194   FORMAT(T28,' SMALL TREE HTG: SPECIES = ',I2,' (',A3,
c     &  ') CALCULATED CALIBRATION VALUE = ',F8.2)
c        CORNEW=1.0
c        HCOR(ISPC)=0.0
c      ENDIF
c   80 CONTINUE
c      CORTEM(IREFI) = CORNEW
c      NUMCAL(IREFI) = N
c  100 CONTINUE
cC----------
cC  END OF CALIBRATION LOOP.  PRINT CALIBRATION STATISTICS AND RETURN
cC----------
c      WRITE(JOSTND,9993) (NUMCAL(I),I=1,NUMSP)
c 9993 FORMAT(/' NUMBER OF RECORDS AVAILABLE FOR SCALING'/
c     >       ' THE SMALL TREE HEIGHT INCREMENT MODEL',
c     >        ((T49,11(I4,2X)/)))
c   95 CONTINUE
c      WRITE(JOSTND,9994) (CORTEM(I),I=1,NUMSP)
c 9994 FORMAT(/' INITIAL SCALE FACTORS FOR THE SMALL TREE'/
c     >      ' HEIGHT INCREMENT MODEL',
c     >       ((T49,11(F5.2,1X)/)))
c
cC----------
cC OUTPUT CALIBRATION TERMS IF CALBSTAT KEYWORD WAS PRESENT.
cC----------
c      IF(JOCALB .GT. 0) THEN
c        KOUT=0
c        DO 207 K=1,MAXSP
c        IF(CORTEM(K).NE.1.0 .OR. NUMCAL(K).GE.NCALHT) THEN
c          SPEC=NSP(MAXSP,1)(1:2)
c          ISPEC=MAXSP
c          DO 203 KK=1,MAXSP
c          IF(K .NE. IREF(KK)) GO TO 203
c          ISPEC=KK
c          SPEC=NSP(KK,1)(1:2)
c          GO TO 2031
c  203     CONTINUE
c 2031     WRITE(JOCALB,204)ISPEC,SPEC,NUMCAL(K),CORTEM(K)
c  204     FORMAT(' CAL: SH',1X,I2,1X,A2,1X,I4,1X,F6.3)
c          KOUT = KOUT + 1
c        ENDIF
c  207   CONTINUE
c        IF(KOUT .EQ. 0)WRITE(JOCALB,209)
c  209   FORMAT(' NO SH VALUES COMPUTED')
c        WRITE(JOCALB,210)
c  210   FORMAT(' CALBSTAT END')
c      ENDIF
   91 IF(DEBUG)WRITE(JOSTND,9995)ICYC
 9995 FORMAT(' LEAVING SUBROUTINE RGNTSW CYCLE =',I5)
      RETURN
      END